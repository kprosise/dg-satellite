{{ template "header" .}}
    <section class="content-section">
      <h2>{{.Title}}</h2>
      <table class="striped">
        <thead>
            <tr>
            <th>Username</th>
            <th>Created at</th>
            <th>Email</th>
            <th>Allowed scopes</th>
            <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{ range .Users}}
            <tr>
            <td>{{.Username}}</td>
            <td>{{tsToString .CreatedAt}}</td>
            <td>{{.Email}}</td>
            <td>{{.AllowedScopes}}</td>
            <td>
              <a href="/users/{{.Username}}/audit-log"><i title="View audit log" class="history"></i></a>
              {{ if and $.CanUpdate }}
              <i title="Change scopes" class="edit" onclick="showScopesModal('{{.Username}}', '{{.AllowedScopes}}')"></i>
              {{ if and $.LocalAuth (ne .Username $.User.Username) }}
              <i title="Reset password" class="password-reset" onclick="showResetPasswordModal('{{.Username}}')"></i>
              {{ end }}
              {{ end }}
              {{ if and $.CanDelete (ne .Username $.User.Username) }}
              <i title="Delete user" class="trash" onclick="deleteUser('{{.Username}}')"></i>
              {{ end }}
            </td>
            </tr>
            {{ end }}
        </tbody>
      </table>
      <dialog id="scopesModal">
        <article>
          <header>
            <button aria-label="Close" rel="prev" onclick="scopesModal.close()"></button>
            <h3>Update user scopes</h3>
          </header>
          <form method="dialog">
            <label for="scopes">Scopes:</label>
            {{range .ScopesList}}
            <input type="checkbox" id="scope-{{.}}" name="scopes" value="{{.}}">
            <label for="scope-{{.}}">{{.}}</label><br>
            {{end}}
          </form>
          <footer>
            <button role="button" onclick="scopesModal.close()">Cancel</button>
            <button autofocus="" role="button" onclick="updateScopes()">Confirm</button>
          </footer>
        </article>
      </dialog>
      {{ if and .LocalAuth .CanUpdate }}
      <dialog id="resetPasswordModal">
        <article>
          <header>
            <button aria-label="Close" rel="prev" onclick="resetPasswordModal.close()"></button>
            <h3>Reset Password</h3>
          </header>
          <form method="dialog">
            <p>Reset password for user: <strong id="resetPasswordUser"></strong></p>
            <label for="resetNewPassword">New Password:</label>
            <input type="password" id="resetNewPassword" name="resetNewPassword" required>
            <label for="resetConfirmPassword">Confirm New Password:</label>
            <input type="password" id="resetConfirmPassword" name="resetConfirmPassword" required>
            <span id="resetPasswordError" style="color: red; display: none;">Passwords do not match</span>
          </form>
          <footer>
            <button role="button" onclick="resetPasswordModal.close()">Cancel</button>
            <button autofocus="" role="button" onclick="resetPassword()">Reset Password</button>
          </footer>
        </article>
      </dialog>
      {{ end }}
    </section>

    <script>
      let currentUser = null;

      function showScopesModal(username, currentScopes) {
        currentUser = username;

        const checkboxes = document.getElementsByName('scopes');
        Array.from(checkboxes).forEach(checkbox => {
          checkbox.checked = false;
        });

        if (currentScopes) {
          const scopesArray = currentScopes.split(',').map(s => s.trim());
          scopesArray.forEach(scope => {
            const checkbox = document.getElementById('scope-' + scope);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
        }

        scopesModal.show();
      }

      function deleteUser(username) {
        if (!confirm('Are you sure you want to delete user "' + username + '"? This action cannot be undone.')) {
          return;
        }

        fetch('/users/' + username, {
          method: 'DELETE',
        })
        .then(async response => {
          if (response.ok) {
            window.location.reload(); // Refresh to show updated user list
          } else {
            const errorText = await response.text();
            alert('Error deleting user: ' + errorText);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error deleting user: ' + error.message);
        });
      }

      let resetUser = null;

      function showResetPasswordModal(username) {
        resetUser = username;
        document.getElementById('resetPasswordUser').textContent = username;
        document.getElementById('resetNewPassword').value = '';
        document.getElementById('resetConfirmPassword').value = '';
        document.getElementById('resetPasswordError').style.display = 'none';
        resetPasswordModal.show();
        document.getElementById('resetNewPassword').focus();
      }

      function resetPassword() {
        if (!resetUser) {
          alert('No user selected.');
          return;
        }

        const newPassword = document.getElementById('resetNewPassword').value;
        const confirmPassword = document.getElementById('resetConfirmPassword').value;

        if (!newPassword) {
          alert('New password is required.');
          return;
        }

        if (newPassword !== confirmPassword) {
          document.getElementById('resetPasswordError').style.display = 'inline';
          return;
        }

        const formData = new FormData();
        formData.append('newPassword', newPassword);

        fetch('/users/' + resetUser + '/reset-password', {
          method: 'POST',
          body: formData
        })
        .then(async response => {
          if (response.ok) {
            resetPasswordModal.close();
          } else {
            const errorText = await response.text();
            alert('Error resetting password: ' + errorText);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error resetting password: ' + error.message);
        });
      }

      // Set up password match validation for reset dialog
      document.addEventListener('DOMContentLoaded', function() {
        const resetConfirm = document.getElementById('resetConfirmPassword');
        const resetNew = document.getElementById('resetNewPassword');
        const resetError = document.getElementById('resetPasswordError');
        if (resetConfirm && resetNew) {
          function checkResetMatch() {
            if (resetConfirm.value && resetNew.value !== resetConfirm.value) {
              resetError.style.display = 'inline';
            } else {
              resetError.style.display = 'none';
            }
          }
          resetConfirm.addEventListener('input', checkResetMatch);
          resetNew.addEventListener('input', checkResetMatch);
        }
      });

      function updateScopes() {
        if (!currentUser) {
          alert('No user selected.');
          return;
        }

        const scopeCheckboxes = document.getElementsByName('scopes');
        const scopes = Array.from(scopeCheckboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);

        const updateData = {
          scopes: scopes
        };

        fetch('/users/' + currentUser + '/scopes', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updateData)
        })
        .then(async response => {
          if (response.ok) {
            scopesModal.close();
            window.location.reload(); // Refresh to show updated scopes
          } else {
            const errorText = await response.text();
            alert('Error updating scopes: ' + errorText);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating scopes: ' + error.message);
        });
      }
    </script>

{{ template "footer"}}