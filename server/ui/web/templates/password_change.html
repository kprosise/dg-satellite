{{define "password_change_script"}}
<script>
  function setupPasswordMatchValidation(newPasswordId, confirmPasswordId, errorSpanId) {
    var confirmInput = document.getElementById(confirmPasswordId);
    var newInput = document.getElementById(newPasswordId);
    var errorSpan = document.getElementById(errorSpanId);

    function checkMatch() {
      var newVal = newInput.value;
      var confirmVal = confirmInput.value;
      if (confirmVal && newVal !== confirmVal) {
        errorSpan.style.display = 'inline';
      } else {
        errorSpan.style.display = 'none';
      }
    }

    confirmInput.addEventListener('input', checkMatch);
    newInput.addEventListener('input', checkMatch);
  }

  function submitPasswordChange(currentPassword, newPassword, confirmPassword, onSuccess) {
    if (newPassword !== confirmPassword) {
      alert('New password and confirmation do not match.');
      return;
    }

    var formData = new FormData();
    formData.append('currentPassword', currentPassword);
    formData.append('newPassword', newPassword);

    fetch('/users/{{.User.Username}}/password', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        if (onSuccess) {
          onSuccess();
        } else {
          window.location.reload();
        }
      } else {
        return response.text().then(errorText => {
          throw new Error(errorText || 'HTTP ' + response.status + ': ' + response.statusText);
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to change password: ' + error.message);
    });
  }
</script>
{{end}}
