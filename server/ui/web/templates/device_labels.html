{{ template "header" .}}
    <section class="content-section">
      <h2>{{.Title}}</h2>

      <section>
	There are two standard labels:
	<ul>
	  <li><b>name</b> - a unique device name;</li>
	  <li><b>group</b> - a device group, used to rollout device updates.</li>
	</ul>
	<p>Arbitrary label names are also supported.</p>
      </section>

      <form>
        <fieldset class="grid">
          <label style="font-weight: bold;">Key</label>
          <label style="font-weight: bold;">Value</label>
        </fieldset>

        <div id="labelsContainer">
          {{ range $key, $value := .Device.Labels }}
          <fieldset class="grid">
	    <input list="label-keys" value="{{$key}}" onblur="onKeyBlur(this)"/>
            <input value="{{$value}}" {{ if eq $key "group" }} list="group-values" {{ end }} />
            <i class="trash" title="Remove label"></i>
          </fieldset>
          {{ end }}
        </div>

        <button type="button" onclick="addNewLabel()">Add new label</button>

	<datalist id="label-keys">
		{{ range $_, $key := .KnownLabels }}
		<option value="{{$key}}"/>
		{{ end }}
	</datalist>
	<datalist id="group-values">
		{{ range $_, $group := .KnownGroups }}
		<option value="{{$group}}"/>
		{{ end }}
	</datalist>
      </form>
    </section>
    
    <section class="content-section">
      <button onclick="location.href='/devices/{{.Device.Uuid}}';">Cancel</button>
      <button onclick="saveLabels()">Save changes</button>
    </section>
    
    <script>
      function addNewLabel() {
        const container = document.getElementById('labelsContainer');
        const newFieldset = document.createElement('fieldset');
        newFieldset.className = 'grid';
        newFieldset.innerHTML = `
          <input list="label-keys" placeholder="Type to select or enter key" onblur="onKeyBlur(this)"/>
          <input placeholder="Enter value"/>
          <i class="trash" title="Remove label" onclick="removeLabel(this)"></i>
        `;
        container.appendChild(newFieldset);
      }

      function removeLabel(element) {
        const fieldset = element.parentElement;
        fieldset.remove();
      }

      function saveLabels() {
        const container = document.getElementById('labelsContainer');
        const fieldsets = container.querySelectorAll('fieldset');
        const labels = {};
        
        fieldsets.forEach(fieldset => {
          const inputs = fieldset.querySelectorAll('input');
          if (inputs.length >= 2) {
            const key = inputs[0].value.trim();
            const value = inputs[1].value.trim();
            
            // Only include non-empty keys
            if (key) {
              labels[key] = value;
            }
          }
        });

        fetch('/v1/devices/{{.Device.Uuid}}/labels', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(labels)
        })
        .then(async response => {
          if (response.ok) {
            location.href = '/devices/{{.Device.Uuid}}';
          } else {
            const errorText = await response.text();
            alert('Error saving labels: ' + errorText);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error saving labels: ' + error.message);
        });
      }

      function onKeyBlur(element) {
        if (element.value.trim() != 'group') {
          return;
        }
        const fieldset = element.parentElement;
        const inputs = fieldset.querySelectorAll('input');
        if (inputs.length >= 2) {
          inputs[1].setAttribute('list', 'group-values')
        }
      }

      // Add click handlers to existing trash icons
      document.addEventListener('DOMContentLoaded', function() {
        const trashIcons = document.querySelectorAll('.trash');
        trashIcons.forEach(icon => {
          icon.addEventListener('click', function() {
            removeLabel(this);
          });
        });
      });
    </script>

{{ template "footer"}}
